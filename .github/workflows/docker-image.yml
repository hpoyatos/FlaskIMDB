name: Build e Deploy Docker no Windows Desktop Local (teste de desenvolvimento)

on:
  push:
    branches: [ "dev" ]

jobs:

  build-and-run:
    runs-on: [self-hosted, Windows]

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Build da imagem Docker
        shell: powershell
        run: |
          docker build -t flaskimdb:latest .

      - name: Parar container antigo (se existir)
        shell: powershell
        run: |
          $ErrorActionPreference = "SilentlyContinue"

          Write-Host "Verificando se existe container 'flaskimdb'..."
          $container = docker ps -aq -f "name=flaskimdb"

          if ($container) {
            Write-Host "Container encontrado: $container. Parando..."
            docker stop $container
            Write-Host "Removendo container..."
            docker rm $container
          }
          else {
            Write-Host "Nenhum container 'flaskimdb' para parar/remover."
          }

          exit 0

      - name: Subir novo container
        shell: powershell
        run: |
          docker run -d `
            --name flaskimdb `
            -p 5000:5000 `
            --restart unless-stopped `
            flaskimdb:latest
